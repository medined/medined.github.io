---
layout: post
title: Docker Swarm 1.12 on PicoCluster
date: '2016-07-17T12:40:00.003-04:00'
author: David Medinets
tags: 
modified_time: '2016-07-17T12:40:33.744-04:00'
blogger_id: tag:blogger.com,1999:blog-3207985.post-4053158554290852436
blogger_orig_url: http://affy.blogspot.com/2016/07/docker-swarm-112-on-picocluster.html
---

I followed the directions at https://medium.com/@bossjones/how-i-setup-a-raspberry-pi-3-cluster-using-the-new-docker-swarm-mode-in-29-minutes-aa0e4f3b1768#.ma06iyonf but tweaked them a bit.<br />
<br />
First off, I wanted to have my cluster using eth0 to connect to my laptop and then share its WiFi connection. Using this technique means that my WiFi network name and password are not on the cluster. So the cluster should be able to plug into any laptop or server without changes. Follow instructions at https://t.co/2jRbNAOiCU to share your eth0 connection.<br />
<br />
<br />
<br />
Use lsblk to umount any directories on the SD cards you'll be using. See http://affy.blogspot.com/2016/06/how-did-i-prepare-my-picocluster-for.html for a bit of information about lsblk.<br />
<br />
Now flash the SD cards using the flash tool from hypriot. Notice that *no* network information is provided.<br />
<br />
I used piX naming convention so that I can easily loop over all five RPI in the PicoCluster.<br />
<br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">flash --hostname pi1 --device /dev/mmcblk0 https://github.com/hypriot/image-builder-rpi/releases/download/v0.8.1/hypriotos-rpi-v0.8.1.img.zip<br />flash --hostname pi2 --device /dev/mmcblk0 https://github.com/hypriot/image-builder-rpi/releases/download/v0.8.1/hypriotos-rpi-v0.8.1.img.zip<br />flash --hostname pi3 --device /dev/mmcblk0 https://github.com/hypriot/image-builder-rpi/releases/download/v0.8.1/hypriotos-rpi-v0.8.1.img.zip<br />flash --hostname pi4 --device /dev/mmcblk0 https://github.com/hypriot/image-builder-rpi/releases/download/v0.8.1/hypriotos-rpi-v0.8.1.img.zip<br />flash --hostname pi5 --device /dev/mmcblk0 https://github.com/hypriot/image-builder-rpi/releases/download/v0.8.1/hypriotos-rpi-v0.8.1.img.zip</span><br />
<br />
<br />Using this function, you can find the IP addresses for the RPI.&nbsp; <br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">function getip() { (traceroute $1 2&gt;&amp;1 | head -n 1 | cut -d\( -f 2 | cut -d\) -f 1) }</span><br /><br />List the IP addresses.<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">for i in `seq 1 5`; do echo "HOST: pi$i&nbsp; IP: $(getip pi$i.local)"; done</span><br /><br />Remove any fingerprints for the RPI. <br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">for i in `seq 1 5`; do ssh-keygen -R pi${i}.local 2&gt;/dev/null; done</span><br /><br />Copy your PKI identity to the RPI.<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">for i in `seq 1 5`; do ssh-copy-id -oStrictHostKeyChecking=no -oCheckHostIP=no pirate@pi${i}.local; done</span><br /><br />Download the deb file for Docker v1.12<br /><br /><span style="font-family: &quot;Courier New&quot;,Courier,monospace;">curl -O https://jenkins.hypriot.com/job/armhf-docker/17/artifact/bundles/latest/build-deb/raspbian-jessie/docker-engine_1.12.0%7Erc4-0%7Ejessie_armhf.deb</span><br /><br />Copy the deb file to the RPI<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">for i in `seq 1 5`; do scp -oStrictHostKeyChecking=no -oCheckHostIP=no docker-engine_1.12.0%7Erc4-0%7Ejessie_armhf.deb pirate@pi$i.local:.; done</span><br />Remove older Docker version from the RPI<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">for i in `seq 1 5`; do ssh -oStrictHostKeyChecking=no -oCheckHostIP=no pirate@pi$i.local sudo apt-get purge -y docker-hypriot; done</span><br /><br />Install Docker<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">for i in `seq 1 5`; do ssh -oStrictHostKeyChecking=no -oCheckHostIP=no pirate@pi$i.local sudo dpkg -i docker-engine_1.12.0%7Erc4-0%7Ejessie_armhf.deb; done</span><br /><br />Initialize the Swarm<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">ssh -oStrictHostKeyChecking=no -oCheckHostIP=no pirate@pi1.local docker swarm init</span><br /><br />Join slaves to Swarm - replace the join command below with the specific one displayed by the init command.<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">for i in `seq 2 5`; do <br />&nbsp; ssh -oStrictHostKeyChecking=no -oCheckHostIP=no pirate@pi$i.local docker swarm join --secret ceuok9jso0klube8m3ih9gcsv --ca-hash sha256:f0864eb57963e3f9cd1756e691d0b609903e3a0bb48785272ea53155809025ee 10.42.0.49:2377;<br />done</span><br />Exercise the Swarm<br />
<br />
<span style="font-family: &quot;Courier New&quot;,Courier,monospace;">ssh -oStrictHostKeyChecking=no -oCheckHostIP=no pirate@pi1.local<br />docker service create --name ping hypriot/rpi-alpine-scratch ping 8.8.8.8<br />docker service tasks ping<br />docker service update --replicas 10 ping<br />docker service tasks ping<br />docker service rm ping</span><br />
<br />